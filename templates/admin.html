{% extends "base.html" %}

{% block title %}Panel Admin - Taquería Pro{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>
        <i class="fas fa-cog"></i> Panel de Administración
    </h2>

    <!-- Tabs -->
    <div style="display: flex; gap: 0; border-bottom: 2px solid #ecf0f1; margin-bottom: 2rem; flex-wrap: wrap;">
        <button class="tab-btn active" onclick="mostrarTab('usuarios')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; color: #95a5a6; transition: all 0.3s;">
            <i class="fas fa-users"></i> Usuarios
        </button>
        <button class="tab-btn" onclick="mostrarTab('productos')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; color: #95a5a6; transition: all 0.3s;">
            <i class="fas fa-box"></i> Productos
        </button>
        <button class="tab-btn" onclick="mostrarTab('mesas')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; color: #95a5a6; transition: all 0.3s;">
            <i class="fas fa-chair"></i> Mesas
        </button>
    </div>

    <!-- TAB: USUARIOS -->
    <div id="tab-usuarios" class="tab-content">
        <h3 style="color: #2c3e50; margin-bottom: 1.5rem;">
            <i class="fas fa-users"></i> Gestión de Usuarios
        </h3>
        
        <div class="table-responsive" style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Usuario</th>
                        <th>Rol</th>
                        <th>Creado</th>
                        <th>Último Acceso</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td><strong>#{{ user.id }}</strong></td>
                        <td>{{ user.username }}</td>
                        <td>
                            <span class="badge" style="background: 
                                {% if user.role == 'admin' %}#e74c3c
                                {% elif user.role == 'mesero' %}#3498db
                                {% elif user.role == 'cocina' %}#f39c12
                                {% else %}#27ae60
                                {% endif %}
                            ; color: white;">
                                {{ user.role|upper }}
                            </span>
                        </td>
                        <td style="font-size: 0.9rem;">{{ user.created_at[:10] }}</td>
                        <td style="font-size: 0.9rem; color: #95a5a6;">
                            {{ user.last_login[:10] if user.last_login else 'Nunca' }}
                        </td>
                        <td>
                            <button onclick="openEditModal('users', {{ user.id }})" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            {% if user.id != 1 %}
                            <button onclick="deleteEntity('users', {{ user.id }})" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- TAB: PRODUCTOS -->
    <div id="tab-productos" class="tab-content" style="display: none;">
        <h3 style="color: #2c3e50; margin-bottom: 1.5rem;">
            <i class="fas fa-box"></i> Gestión de Productos
        </h3>
        
        <div class="table-responsive" style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Categoría</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td><strong>#{{ product.id }}</strong></td>
                        <td>{{ product.name }}</td>
                        <td>
                            <span class="badge" style="background: 
                                {% if product.category == 'tacos' %}#f39c12
                                {% elif product.category == 'bebidas' %}#3498db
                                {% elif product.category == 'extras' %}#9b59b6
                                {% else %}#e74c3c
                                {% endif %}
                            ; color: white;">
                                {{ product.category|upper }}
                            </span>
                        </td>
                        <td style="font-weight: 600; color: #27ae60;">${{ "%.2f"|format(product.price) }}</td>
                        <td>
                            {% if product.stock %}
                                <span style="background: #d4edda; color: #155724; padding: 0.25rem 0.75rem; border-radius: 3px;">
                                    {{ product.stock }}
                                </span>
                            {% else %}
                                <span style="color: #95a5a6;">Sin límite</span>
                            {% endif %}
                        </td>
                        <td>
                            <button onclick="openEditModal('products', {{ product.id }})" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button onclick="deleteEntity('products', {{ product.id }})" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- TAB: MESAS -->
    <div id="tab-mesas" class="tab-content" style="display: none;">
        <h3 style="color: #2c3e50; margin-bottom: 1.5rem;">
            <i class="fas fa-chair"></i> Gestión de Mesas
        </h3>
        
        <div class="table-responsive" style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Capacidad</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mesa in mesas %}
                    <tr>
                        <td><strong>#{{ mesa.id }}</strong></td>
                        <td>{{ mesa.name }}</td>
                        <td>{{ mesa.capacity }} personas</td>
                        <td>
                            <span class="badge" style="background: 
                                {% if mesa.status == 'disponible' %}#27ae60
                                {% elif mesa.status == 'ocupada' %}#e74c3c
                                {% else %}#f39c12
                                {% endif %}
                            ; color: white;">
                                {{ mesa.status|upper }}
                            </span>
                        </td>
                        <td>
                            <button onclick="openEditModal('tables', {{ mesa.id }})" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button onclick="deleteEntity('tables', {{ mesa.id }})" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL EDITAR -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div class="card" style="width: 90%; max-width: 500px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 id="modalTitle" style="margin: 0;">Editar</h3>
            <button onclick="closeEditModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #95a5a6;">✕</button>
        </div>

        <form id="editForm" onsubmit="submitEditForm(e)">
            <input type="hidden" id="entityType">
            <input type="hidden" id="entityId">
            <div id="formFields"></div>
            
            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-save"></i> Guardar
                </button>
                <button type="button" onclick="closeEditModal()" class="btn btn-secondary" style="flex: 1;">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Tab switching
function mostrarTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.style.borderBottomColor = 'transparent';
        btn.style.color = '#95a5a6';
    });
    
    // Show selected tab
    document.getElementById(`tab-${tabName}`).style.display = 'block';
    event.target.style.borderBottomColor = '#e74c3c';
    event.target.style.color = '#e74c3c';
}

// Edit modal
function openEditModal(entityType, entityId) {
    fetch(`/admin/api/${entityType}/${entityId}`)
        .then(r => r.json())
        .then(data => {
            document.getElementById('entityType').value = entityType;
            document.getElementById('entityId').value = entityId;
            
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = '';
            
            if (entityType === 'users') {
                document.getElementById('modalTitle').textContent = `Editar Usuario: ${data.username}`;
                formFields.innerHTML = `
                    <div class="form-group">
                        <label>Usuario</label>
                        <input type="text" id="fieldUsername" value="${data.username}" required>
                    </div>
                    <div class="form-group">
                        <label>Rol</label>
                        <select id="fieldRole" required>
                            <option value="admin" ${data.role === 'admin' ? 'selected' : ''}>Admin</option>
                            <option value="mesero" ${data.role === 'mesero' ? 'selected' : ''}>Mesero</option>
                            <option value="cocina" ${data.role === 'cocina' ? 'selected' : ''}>Cocina</option>
                            <option value="caja" ${data.role === 'caja' ? 'selected' : ''}>Caja</option>
                        </select>
                    </div>
                `;
            } else if (entityType === 'products') {
                document.getElementById('modalTitle').textContent = `Editar Producto: ${data.name}`;
                formFields.innerHTML = `
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" id="fieldName" value="${data.name}" required>
                    </div>
                    <div class="form-group">
                        <label>Categoría</label>
                        <select id="fieldCategory" required>
                            <option value="tacos" ${data.category === 'tacos' ? 'selected' : ''}>Tacos</option>
                            <option value="bebidas" ${data.category === 'bebidas' ? 'selected' : ''}>Bebidas</option>
                            <option value="extras" ${data.category === 'extras' ? 'selected' : ''}>Extras</option>
                            <option value="postres" ${data.category === 'postres' ? 'selected' : ''}>Postres</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Precio</label>
                        <input type="number" id="fieldPrice" value="${data.price}" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Stock</label>
                        <input type="number" id="fieldStock" value="${data.stock || ''}" step="1">
                    </div>
                `;
            } else if (entityType === 'tables') {
                document.getElementById('modalTitle').textContent = `Editar Mesa: ${data.name}`;
                formFields.innerHTML = `
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" id="fieldName" value="${data.name}" required>
                    </div>
                `;
            }
            
            document.getElementById('editModal').style.display = 'flex';
        })
        .catch(err => showToast('Error: ' + err, 'error'));
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

function submitEditForm(e) {
    e.preventDefault();
    const entityType = document.getElementById('entityType').value;
    const entityId = document.getElementById('entityId').value;
    
    let data = {};
    if (entityType === 'users') {
        data = {
            username: document.getElementById('fieldUsername').value,
            role: document.getElementById('fieldRole').value
        };
    } else if (entityType === 'products') {
        data = {
            name: document.getElementById('fieldName').value,
            category: document.getElementById('fieldCategory').value,
            price: parseFloat(document.getElementById('fieldPrice').value),
            stock: document.getElementById('fieldStock').value || null
        };
    } else if (entityType === 'tables') {
        data = {
            name: document.getElementById('fieldName').value
        };
    }
    
    fetch(`/admin/api/${entityType}/${entityId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showToast('Actualizado correctamente', 'success');
            closeEditModal();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(result.error || 'Error', 'error');
        }
    })
    .catch(err => showToast('Error: ' + err, 'error'));
}
</script>
{% endblock %}
